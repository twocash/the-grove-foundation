# Results Wiring v1 - Execution Prompt

**Sprint:** `results-wiring-v1`
**Protocol:** Grove Execution Protocol v1.5
**Role:** Coding Agent
**Handoff Date:** 2026-01-14

---

## Constitutional References

Before starting, read these files:
- [ ] `docs/BEDROCK_SPRINT_CONTRACT.md` - Visual verification requirements
- [ ] `src/core/schema/research-document.ts` - ResearchDocument schema
- [ ] `src/core/schema/research-sprout.ts` - ResearchSprout schema
- [ ] `src/explore/mocks/mock-research-document.ts` - Mock to be replaced
- [ ] `tests/e2e/_test-utils.ts` - Console monitoring utilities

---

## Attention Anchor

**Re-read this block before every major decision.**

- **We are building:** Real research results display - wiring actual sprout data to GardenInspector
- **Success looks like:** Users click completed sprouts and see THEIR research findings, not fake "Google Achieves Quantum Supremacy" content
- **We are NOT:** Building new UI components (already done in Results Display v1), modifying the research pipeline, or changing evidence collection
- **The fix is surgical:** Replace one function call with real data access + fallback converter

---

## Strangler Fig Boundaries

```
FROZEN ZONE - DO NOT TOUCH
├── /terminal route
├── src/surface/components/Terminal/*
└── src/workspace/*

ACTIVE BUILD ZONE - WHERE WE WORK
├── /explore route <-- THIS SPRINT
├── src/explore/*
├── src/core/schema/*
└── supabase/migrations/*
```

---

## Phase 1: Schema + Storage

### Goal
Add `researchDocument` field to sprout and persist it when pipeline completes.

### File 1: `src/core/schema/research-sprout.ts` (~line 270)

**Find the ResearchSprout interface and add:**
```typescript
/**
 * Full ResearchDocument generated by writer agent.
 * Stored when pipeline completes for direct display.
 * If absent (legacy sprouts), use sproutToResearchDocument() fallback.
 */
researchDocument?: ResearchDocument;
```

### File 2: `src/explore/context/ResearchSproutContext.tsx` (~lines 400-450)

**Find the `updateResults()` function and modify to accept/persist document:**

Look for pattern:
```typescript
const updateResults = useCallback(async (
  sproutId: string,
  results: SynthesisResult,
  evidence: Evidence[]
) => {
```

Update to:
```typescript
const updateResults = useCallback(async (
  sproutId: string,
  results: SynthesisResult,
  evidence: Evidence[],
  researchDocument?: ResearchDocument  // ADD THIS PARAMETER
) => {
  // ... existing code ...

  // ADD: Store document if provided
  if (researchDocument) {
    updatedSprout.researchDocument = researchDocument;
  }
```

### File 3: `src/explore/context/ResearchExecutionContext.tsx` (~lines 94-113)

**Find where pipeline completes and pass the document:**

Look for pattern:
```typescript
// Pipeline completion handler
if (result.document) {
  // Currently not stored - FIX THIS
}
```

Update to pass `result.document` to `updateResults()`.

### Gate Check
```bash
npm run build
# Must compile without TypeScript errors
```

---

## Phase 2: Display Wiring

### Goal
Replace mock with real data in GardenInspector.

### File: `src/explore/GardenInspector.tsx` (lines 107-115)

**BEFORE (current code):**
```typescript
// TODO: Replace with actual document retrieval from storage
const researchDocument: ResearchDocument | null = useMemo(() => {
  if (selectedSprout?.status === 'completed') {
    // For MVP, generate mock document based on sprout's spark
    return createMockResearchDocument(selectedSprout.spark);
  }
  return null;
}, [selectedSprout]);
```

**AFTER:**
```typescript
// Real research document from sprout or fallback conversion
const researchDocument: ResearchDocument | null = useMemo(() => {
  if (selectedSprout?.status === 'completed') {
    // Use stored document, or convert legacy sprout
    return selectedSprout.researchDocument ?? sproutToResearchDocument(selectedSprout);
  }
  return null;
}, [selectedSprout]);
```

**Also update imports:**
```typescript
// REMOVE:
import { createMockResearchDocument } from './mocks/mock-research-document';

// ADD:
import { sproutToResearchDocument } from './utils/sprout-to-document';
```

### Gate Check
- Visual verification: Click a completed sprout
- Content should NOT show "Quantum computing" or "ionq.com"

---

## Phase 3: Fallback Converter

### Goal
Handle legacy sprouts without stored `researchDocument`.

### New File: `src/explore/utils/sprout-to-document.ts`

```typescript
/**
 * Converts a legacy ResearchSprout to ResearchDocument format.
 * Used as fallback when sprout.researchDocument is not stored.
 *
 * Mapping:
 * - synthesis.summary → position
 * - synthesis.insights + evidence[] → analysis markdown
 * - evidence[] → citations[] with indices
 * - synthesis.confidence → confidenceScore
 */

import type { ResearchDocument, Citation } from '@core/schema/research-document';
import type { ResearchSprout } from '@core/schema/research-sprout';

export function sproutToResearchDocument(sprout: ResearchSprout): ResearchDocument {
  const { synthesis, evidence = [] } = sprout;

  // Build citations from evidence
  const citations: Citation[] = evidence.map((e, index) => ({
    index: index + 1,
    source: e.source || 'Unknown source',
    url: e.url || '',
    relevance: e.relevance || 0.5,
    snippet: e.snippet || e.content?.substring(0, 200) || ''
  }));

  // Build analysis markdown from insights
  const insightsMarkdown = synthesis?.insights?.length
    ? synthesis.insights.map((insight, i) => `${i + 1}. ${insight}`).join('\n')
    : '';

  // Build evidence references
  const evidenceMarkdown = evidence.length
    ? `\n\n**Supporting Evidence:**\n${evidence.map((e, i) =>
        `- [${i + 1}] ${e.snippet || e.content?.substring(0, 100) || 'Evidence'}${e.url ? ` ([source](${e.url}))` : ''}`
      ).join('\n')}`
    : '';

  return {
    id: `legacy-${sprout.id}`,
    title: sprout.spark || 'Research Results',
    position: synthesis?.summary || 'No summary available for this research.',
    analysis: `${insightsMarkdown}${evidenceMarkdown}`,
    citations,
    confidenceScore: synthesis?.confidence ?? 0.5,
    generatedAt: sprout.completedAt || new Date().toISOString(),
    model: 'legacy-conversion'
  };
}
```

### Gate Check
- Load a legacy sprout (without `researchDocument` field)
- Should render without errors
- Should show content from sprout's synthesis/evidence

---

## Phase 4: E2E Testing (Constraint 11)

### Goal
Console-monitored E2E test proving real data displays.

### New File: `tests/e2e/results-wiring.spec.ts`

```typescript
import { test, expect } from '@playwright/test';
import { setupConsoleCapture, getCriticalErrors } from './_test-utils';

const SCREENSHOT_DIR = 'docs/sprints/results-wiring-v1/screenshots';

test.describe('Results Wiring v1 - Real Research Display', () => {
  test('AC-RW001: Shows REAL citations, not quantum computing mock', async ({ page }) => {
    const capture = setupConsoleCapture(page);

    // Step 1: Navigate to explore
    await page.goto('/explore');
    await page.waitForLoadState('networkidle');
    await page.screenshot({ path: `${SCREENSHOT_DIR}/01-explore-loaded.png` });

    // Step 2: Find a completed sprout (or create one if needed)
    // Look for sprout with 'completed' status in GardenTray
    const completedSprout = page.locator('[data-status="completed"]').first();

    if (await completedSprout.isVisible()) {
      // Step 3: Click the completed sprout
      await completedSprout.click();
      await page.waitForTimeout(500);
      await page.screenshot({ path: `${SCREENSHOT_DIR}/02-sprout-selected.png` });

      // Step 4: Get results content
      const resultsPanel = page.locator('.research-results, [data-testid="research-results"]');
      await resultsPanel.waitFor({ state: 'visible', timeout: 5000 });

      const content = await resultsPanel.textContent();
      await page.screenshot({ path: `${SCREENSHOT_DIR}/03-results-displayed.png` });

      // CRITICAL ASSERTIONS - Must NOT contain mock quantum content
      expect(content).not.toContain('Quantum computing');
      expect(content).not.toContain('Google Achieves Quantum Supremacy');
      expect(content).not.toContain('ionq.com');
      expect(content).not.toContain('quantum supremacy');

      // Should contain real research content (from sprout's spark/synthesis)
      // Note: Exact content depends on what was researched
    }

    // Step 5: Verify no critical console errors (Constraint 11)
    const criticalErrors = getCriticalErrors(capture.errors);
    expect(criticalErrors).toHaveLength(0);

    await page.screenshot({ path: `${SCREENSHOT_DIR}/04-final-state.png` });
  });

  test('AC-RW004: Legacy sprouts render without errors', async ({ page }) => {
    const capture = setupConsoleCapture(page);

    await page.goto('/explore');
    await page.waitForLoadState('networkidle');

    // Interact with any available sprout
    const anySprout = page.locator('[data-testid="sprout-row"]').first();
    if (await anySprout.isVisible()) {
      await anySprout.click();
      await page.waitForTimeout(500);
    }

    // No critical errors should occur
    const criticalErrors = getCriticalErrors(capture.errors);
    expect(criticalErrors).toHaveLength(0);
  });

  test('AC-RW005: Zero console errors during display', async ({ page }) => {
    const capture = setupConsoleCapture(page);

    await page.goto('/explore');
    await page.waitForLoadState('networkidle');

    // Basic interaction
    const completedSprout = page.locator('[data-status="completed"]').first();
    if (await completedSprout.isVisible()) {
      await completedSprout.click();
      await page.waitForTimeout(1000);

      // Scroll if results are scrollable
      const resultsPanel = page.locator('.research-results');
      if (await resultsPanel.isVisible()) {
        await resultsPanel.evaluate(el => el.scrollTop = el.scrollHeight);
        await page.waitForTimeout(300);
      }
    }

    // Verify zero critical errors
    const criticalErrors = getCriticalErrors(capture.errors);
    console.log('Console errors captured:', capture.errors);
    expect(criticalErrors).toHaveLength(0);
  });
});
```

### Run Tests
```bash
npx playwright test tests/e2e/results-wiring.spec.ts --project=e2e
```

### Gate Check
- All tests pass
- Zero critical console errors
- Screenshots captured in `docs/sprints/results-wiring-v1/screenshots/`

---

## Phase 5: Cleanup + Documentation

### Goal
Remove mock, update REVIEW.html.

### Step 1: Remove Mock Import
In `src/explore/GardenInspector.tsx`, ensure the mock import is removed:
```typescript
// DELETE this line if still present:
import { createMockResearchDocument } from './mocks/mock-research-document';
```

### Step 2: Mark Mock as Deprecated (Optional)
In `src/explore/mocks/mock-research-document.ts`, add deprecation notice:
```typescript
/**
 * @deprecated Use sprout.researchDocument or sproutToResearchDocument() instead.
 * This mock was replaced in results-wiring-v1 sprint.
 */
```

### Step 3: Create REVIEW.html
```bash
# Create screenshots directory if not exists
mkdir -p docs/sprints/results-wiring-v1/screenshots
```

Create `docs/sprints/results-wiring-v1/REVIEW.html` with AC-to-screenshot mapping.

### Step 4: Run Code Simplifier
```bash
# Run on modified files
npx tsx scripts/code-simplifier.ts src/explore/GardenInspector.tsx
npx tsx scripts/code-simplifier.ts src/explore/utils/sprout-to-document.ts
```

---

## Verification Checklist

### Build Gates
- [ ] `npm run build` passes
- [ ] No TypeScript errors
- [ ] No ESLint errors

### Functional Gates
- [ ] Completed sprout shows real research content
- [ ] Content does NOT contain "Quantum computing" or mock data
- [ ] Legacy sprouts render without errors
- [ ] Loading state shows during retrieval (if async)

### E2E Gates (Constraint 11)
- [ ] `tests/e2e/results-wiring.spec.ts` passes
- [ ] Console monitoring captures zero critical errors
- [ ] Screenshots captured for all ACs

### Documentation Gates
- [ ] REVIEW.html created with AC mapping
- [ ] Screenshots in `docs/sprints/results-wiring-v1/screenshots/`
- [ ] Mock marked as deprecated

---

## Success Criteria

**Sprint Complete When:**
- [x] All phases completed with verification
- [x] All ACs verified with screenshots
- [x] E2E test passes with console monitoring
- [x] Zero critical console errors
- [x] Code-simplifier applied
- [x] REVIEW.html complete
- [x] Mock removed/deprecated

**Sprint Failed If:**
- Results still show quantum computing mock
- Critical console errors detected
- Legacy sprouts broken
- Any FROZEN ZONE file modified

---

## Quick Reference

### Key Files
| File | Purpose |
|------|---------|
| `src/explore/GardenInspector.tsx:107-115` | Replace mock with real data |
| `src/core/schema/research-sprout.ts` | Add `researchDocument` field |
| `src/explore/context/ResearchSproutContext.tsx` | Persist document in updateResults |
| `src/explore/context/ResearchExecutionContext.tsx` | Store pipeline result |
| `src/explore/utils/sprout-to-document.ts` | NEW - Fallback converter |
| `tests/e2e/results-wiring.spec.ts` | NEW - E2E with console monitoring |

### Test Commands
```bash
# Build check
npm run build

# E2E test
npx playwright test tests/e2e/results-wiring.spec.ts --project=e2e

# Visual check
npm run dev
# Navigate to /explore, click completed sprout
```

---

*This contract is binding. Deviation requires explicit human approval.*
