# Micro-Sprint: Prompt Generation (Epic 4)

**Sprint:** sprout-declarative-v1-epic4  
**Parent:** sprout-declarative-v1  
**Date:** December 30, 2024  
**For:** Claude Code CLI  
**Estimated:** 1-2 hours  

---

## Mission

Add prompt generation capability to ResearchManifestCard. Users can accumulate clues and directions, then generate a copy-paste ready research prompt.

**Success Criteria:**
1. "Generate Prompt" button in ResearchManifestCard
2. PromptPreviewModal displays formatted prompt
3. Copy to clipboard works with success feedback
4. Sprout stage advances to 'branching' after generation

---

## Pre-Flight

```bash
cd C:\GitHub\the-grove-foundation
git status  # Should be clean
npm run build  # Verify baseline
npm test  # 376 tests should pass
```

---

## Context Files (Read First)

```
# Schema (ResearchManifest type)
src/core/schema/sprout.ts

# Existing UI (will add Generate button)
src/surface/components/KineticStream/Capture/components/ResearchManifestCard.tsx

# Config (purpose promptFramings)
data/research-purposes.json

# Orchestrator (may need modal state)
src/surface/components/KineticStream/ExploreShell.tsx
```

---

## Task 1: Create Prompt Template

**File:** `data/research-prompt-template.md`

```markdown
# Research Request: {{purpose.label}}

## Seed Insight

> {{seed}}

{{#if provenance}}
**Context:** Captured via {{provenance.lens.name}} lens{{#if provenance.journey.name}} during {{provenance.journey.name}} journey{{/if}}
{{/if}}

---

## Research Purpose

{{purpose.promptFraming}}

{{#if clues.length}}
---

## Clues to Follow

{{#each clues}}
- **[{{type}}]** {{value}}{{#if note}} â€” *{{note}}*{{/if}}
{{/each}}
{{/if}}

{{#if directions.length}}
---

## Research Directions

{{#each directions}}
{{inc @index}}. {{this}}
{{/each}}
{{/if}}

---

## Requested Output

Please provide:
1. **Summary** (2-3 paragraphs synthesizing findings)
2. **Key Sources** (with full citations)
3. **Confidence Assessment** (what's well-established vs. speculative)
4. **Open Questions** (what remains unclear or needs further research)

---

*Generated by Grove Research System*
*Seed captured: {{capturedAt}}*
```

**Note:** Template uses Handlebars syntax. The `inc` helper adds 1 to index for 1-based numbering.

---

## Task 2: Create Prompt Generator

**File:** `src/lib/prompt-generator.ts`

```typescript
// src/lib/prompt-generator.ts
// Sprint: sprout-declarative-v1-epic4
// Generates research prompts from sprout manifests

import Handlebars from 'handlebars';
import type { Sprout, ResearchManifest } from '@/core/schema/sprout';

// Import template as raw string
import promptTemplate from '@/data/research-prompt-template.md?raw';

// Import purposes for prompt framing lookup
import researchPurposesConfig from '@/data/research-purposes.json';

interface PurposeConfig {
  id: string;
  label: string;
  promptFraming: string;
}

// Register helpers
Handlebars.registerHelper('inc', (value: number) => value + 1);

// Compile template once
const compiledTemplate = Handlebars.compile(promptTemplate);

/**
 * Generate a research prompt from a sprout with research manifest
 */
export function generateResearchPrompt(sprout: Sprout): string {
  if (!sprout.researchManifest) {
    throw new Error('Sprout has no research manifest');
  }

  const manifest = sprout.researchManifest;
  
  // Look up purpose config for label and framing
  const purposeConfig = (researchPurposesConfig.purposes as PurposeConfig[])
    .find(p => p.id === manifest.purpose);

  if (!purposeConfig) {
    throw new Error(`Unknown research purpose: ${manifest.purpose}`);
  }

  const context = {
    seed: sprout.response,
    capturedAt: new Date(sprout.capturedAt).toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    }),
    provenance: sprout.provenance,
    purpose: {
      id: manifest.purpose,
      label: purposeConfig.label,
      promptFraming: purposeConfig.promptFraming
    },
    clues: manifest.clues,
    directions: manifest.directions
  };

  return compiledTemplate(context);
}

/**
 * Generate prompt and update sprout with generation metadata
 */
export function generateAndRecordPrompt(sprout: Sprout): {
  prompt: string;
  updatedManifest: ResearchManifest;
} {
  const prompt = generateResearchPrompt(sprout);
  
  const updatedManifest: ResearchManifest = {
    ...sprout.researchManifest!,
    promptGenerated: {
      templateId: 'research-prompt-template-v1',
      generatedAt: new Date().toISOString(),
      rawPrompt: prompt
    }
  };

  return { prompt, updatedManifest };
}
```

**Dependencies:**
```bash
npm install handlebars
```

**TypeScript config** (if needed for raw imports):
```typescript
// vite.config.ts or next.config.js may need adjustment for ?raw imports
// Vite supports this natively
// For Next.js, may need raw-loader or inline the template
```

---

## Task 3: Create PromptPreviewModal

**File:** `src/surface/components/KineticStream/Capture/components/PromptPreviewModal.tsx`

```typescript
// src/surface/components/KineticStream/Capture/components/PromptPreviewModal.tsx
// Sprint: sprout-declarative-v1-epic4

import React, { useState } from 'react';
import { motion, AnimatePresence } from 'framer-motion';

interface PromptPreviewModalProps {
  prompt: string;
  onClose: () => void;
  onConfirm: () => void;  // Called after successful copy, advances stage
}

export const PromptPreviewModal: React.FC<PromptPreviewModalProps> = ({
  prompt,
  onClose,
  onConfirm
}) => {
  const [copied, setCopied] = useState(false);

  const handleCopy = async () => {
    try {
      await navigator.clipboard.writeText(prompt);
      setCopied(true);
      
      // Reset after 2s, then confirm
      setTimeout(() => {
        setCopied(false);
        onConfirm();
      }, 1500);
    } catch (err) {
      console.error('Failed to copy:', err);
    }
  };

  return (
    <motion.div
      className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm"
      initial={{ opacity: 0 }}
      animate={{ opacity: 1 }}
      exit={{ opacity: 0 }}
      onClick={onClose}
    >
      <motion.div
        className="relative w-full max-w-2xl max-h-[80vh] flex flex-col
                   bg-[var(--glass-solid)] border border-[var(--glass-border)]
                   rounded-2xl shadow-2xl overflow-hidden"
        initial={{ scale: 0.95, opacity: 0 }}
        animate={{ scale: 1, opacity: 1 }}
        exit={{ scale: 0.95, opacity: 0 }}
        onClick={e => e.stopPropagation()}
      >
        {/* Header */}
        <div className="flex items-center justify-between p-4 border-b border-[var(--glass-border)]">
          <h2 className="text-lg font-semibold text-[var(--glass-text-primary)]">
            ðŸ“‹ Research Prompt Generated
          </h2>
          <button
            onClick={onClose}
            className="p-2 rounded-lg hover:bg-white/10 transition-colors"
            aria-label="Close"
          >
            <span className="text-[var(--glass-text-muted)]">âœ•</span>
          </button>
        </div>

        {/* Prompt Content */}
        <div className="flex-1 overflow-auto p-4">
          <pre className="whitespace-pre-wrap font-mono text-sm text-[var(--glass-text-secondary)]
                         bg-black/20 rounded-lg p-4 leading-relaxed">
            {prompt}
          </pre>
        </div>

        {/* Footer */}
        <div className="flex items-center justify-between p-4 border-t border-[var(--glass-border)]
                       bg-[var(--glass-bg)]">
          <p className="text-xs text-[var(--glass-text-muted)]">
            Copy and paste into Claude, ChatGPT, or your preferred research tool
          </p>
          <div className="flex gap-2">
            <button
              onClick={onClose}
              className="px-4 py-2 rounded-lg text-sm
                        text-[var(--glass-text-secondary)] hover:bg-white/10
                        transition-colors"
            >
              Cancel
            </button>
            <button
              onClick={handleCopy}
              disabled={copied}
              className={`px-4 py-2 rounded-lg text-sm font-medium transition-all
                         ${copied 
                           ? 'bg-green-500/20 text-green-400' 
                           : 'bg-[var(--neon-cyan)]/20 text-[var(--neon-cyan)] hover:bg-[var(--neon-cyan)]/30'
                         }`}
            >
              {copied ? 'âœ“ Copied!' : 'Copy to Clipboard'}
            </button>
          </div>
        </div>
      </motion.div>
    </motion.div>
  );
};

export default PromptPreviewModal;
```

---

## Task 4: Wire into ResearchManifestCard

**Modify:** `src/surface/components/KineticStream/Capture/components/ResearchManifestCard.tsx`

Add:
1. Import `generateAndRecordPrompt` from `@/lib/prompt-generator`
2. Import `PromptPreviewModal`
3. State: `const [generatedPrompt, setGeneratedPrompt] = useState<string | null>(null)`
4. "Generate Prompt" button (enabled when purpose selected and at least 1 clue or direction)
5. Handler that calls generator, shows modal
6. On confirm, update sprout stage to 'branching' and save

**Button location:** In the action row next to "Save Draft"

```typescript
// Add to imports
import { generateResearchPrompt } from '@/lib/prompt-generator';
import PromptPreviewModal from './PromptPreviewModal';

// Add state
const [showPromptModal, setShowPromptModal] = useState(false);
const [generatedPrompt, setGeneratedPrompt] = useState<string | null>(null);

// Handler
const handleGeneratePrompt = () => {
  // Build temporary sprout object with current form state
  const tempSprout: Sprout = {
    // ... existing sprout fields from context
    researchManifest: {
      purpose,
      clues,
      directions
    }
  };
  
  const prompt = generateResearchPrompt(tempSprout);
  setGeneratedPrompt(prompt);
  setShowPromptModal(true);
};

// On confirm (in modal callback)
const handlePromptConfirm = () => {
  // Save sprout with stage: 'branching' and promptGenerated metadata
  // Then close modal
  setShowPromptModal(false);
  onCapture({ ...sproutData, stage: 'branching' });
};

// Button (add next to Save Draft)
<button
  onClick={handleGeneratePrompt}
  disabled={!purpose || (clues.length === 0 && directions.length === 0)}
  className="..."
>
  Generate Prompt
</button>

// Modal (at end of component, inside AnimatePresence)
{showPromptModal && generatedPrompt && (
  <PromptPreviewModal
    prompt={generatedPrompt}
    onClose={() => setShowPromptModal(false)}
    onConfirm={handlePromptConfirm}
  />
)}
```

---

## Task 5: Export and Index

**Modify:** `src/surface/components/KineticStream/Capture/index.ts`

```typescript
export { PromptPreviewModal } from './components/PromptPreviewModal';
```

**Modify:** `src/lib/index.ts` (if exists, or create)

```typescript
export { generateResearchPrompt, generateAndRecordPrompt } from './prompt-generator';
```

---

## Build Gate

```bash
npm run build
npm test
# Manual test: Create research directive, add clues, generate prompt, copy
```

---

## Completion Checklist

- [ ] `data/research-prompt-template.md` created
- [ ] `src/lib/prompt-generator.ts` created
- [ ] `handlebars` dependency added
- [ ] `PromptPreviewModal.tsx` created
- [ ] ResearchManifestCard has "Generate Prompt" button
- [ ] Button disabled until purpose + content added
- [ ] Modal shows formatted prompt
- [ ] Copy to clipboard works
- [ ] Success feedback shown
- [ ] Sprout stage advances to 'branching'
- [ ] Build passes
- [ ] Tests pass

---

## Edge Cases to Handle

1. **Empty manifest:** Button disabled
2. **No provenance:** Template gracefully omits context line
3. **Clipboard API failure:** Log error, don't crash
4. **Very long prompt:** Modal scrolls properly

---

## Document History

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2024-12-30 | Jim + Claude | Initial micro-sprint |
